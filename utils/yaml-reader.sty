\ProvidesPackage{yaml-reader}
% YAML reader module for LuaLaTeX
% Uses tinyyaml (included in TexLive)

\RequirePackage{luacode}

\begin{luacode*}
local tinyyaml = require("tinyyaml")

-- Table to store all YAML data with prefixes
yaml_stores = {}
-- Current active store (for backward compatibility)
yaml_data = {}
current_prefix = ""

-- Expand tilde to home directory
function expandPath(filepath)
    if filepath:sub(1,1) == "~" then
        local home = os.getenv("HOME")
        if home then
            return home .. filepath:sub(2)
        end
    end
    return filepath
end

-- Load a YAML file (backward compatible - overwrites yaml_data)
function loadYAML(filepath)
    filepath = expandPath(filepath)
    local f = io.open(filepath, "r")
    if not f then
        texio.write_nl("Warning: Cannot open YAML file: " .. filepath)
        return
    end
    local content = f:read("*all")
    f:close()
    yaml_data = tinyyaml.parse(content) or {}
    current_prefix = ""
end

-- Load a YAML file with a prefix
function loadYAMLAs(filepath, prefix)
    filepath = expandPath(filepath)
    local f = io.open(filepath, "r")
    if not f then
        texio.write_nl("Warning: Cannot open YAML file: " .. filepath)
        return
    end
    local content = f:read("*all")
    f:close()
    yaml_stores[prefix] = tinyyaml.parse(content) or {}
end

-- Access a value using dot notation (e.g., "address.city" or "me.address.city")
function getYAML(path)
    local keys = {}
    for key in string.gmatch(path, "[^.]+") do
        table.insert(keys, key)
    end
    
    -- Check if the first key is a prefix
    local val = nil
    if yaml_stores[keys[1]] then
        val = yaml_stores[keys[1]]
        table.remove(keys, 1)
    else
        val = yaml_data
    end
    
    for _, key in ipairs(keys) do
        if val and type(val) == "table" then
            -- Try numeric index first (for arrays)
            local numKey = tonumber(key)
            if numKey then
                val = val[numKey]
            else
                val = val[key]
            end
        else
            return ""
        end
    end
    if type(val) == "table" then
        return ""
    end
    return tostring(val or "")
end

-- Get array length
function getYAMLLength(path)
    local keys = {}
    for key in string.gmatch(path, "[^.]+") do
        table.insert(keys, key)
    end
    
    local val = nil
    if yaml_stores[keys[1]] then
        val = yaml_stores[keys[1]]
        table.remove(keys, 1)
    else
        val = yaml_data
    end
    
    for _, key in ipairs(keys) do
        if val and type(val) == "table" then
            local numKey = tonumber(key)
            if numKey then
                val = val[numKey]
            else
                val = val[key]
            end
        else
            return 0
        end
    end
    if type(val) == "table" then
        return #val
    end
    return 0
end
\end{luacode*}

% Command to load a YAML file (backward compatible)
\newcommand{\LoadYAML}[1]{\directlua{loadYAML([[\detokenize{#1}]])}}

% Command to load a YAML file with a prefix
\newcommand{\LoadYAMLAs}[2]{\directlua{loadYAMLAs([[\detokenize{#1}]], [[#2]])}}

% Command to access a value
\newcommand{\yaml}[1]{\directlua{tex.print(getYAML("#1"))}}

\endinput
